name: Monthly tasks
on:
    schedule:
        # at 06:13 on the first day of the month
        - cron: 13 06 1 * *

jobs:
    create_issue:
        name: Create issue to upgrade dependencies
        runs-on: ubuntu-latest
        permissions:
            issues: write
        steps:
            - name: Create issue to upgrade dependencies
              uses: imjohnbo/issue-bot@76645b39cda009302cc49d8624af634795e9eab5
              with:
                  assignees: "zenabii, kristianulv23, piofinn, fremtindelise, lmfaole"
                  rotate-assignees: true
                  labels: "ğŸ” round robin, ğŸ”— dependencies"
                  close-previous: true
                  title: "Oppdatering av avhengigheter"
                  body: |
                      ## FremgangsmÃ¥te

                      ğŸ§‘â€ğŸ’» KjÃ¸r `git pull` pÃ¥ `main` og lag en ny branch.
                      ğŸ§‘â€ğŸ’» KjÃ¸r `pnpm update -r` pÃ¥ rotnivÃ¥ i prosjektet.
                      ğŸ§‘â€ğŸ’» KjÃ¸r `pnpm outdated -r` pÃ¥ rotnivÃ¥ i prosjektet.

                      Output fra `pnpm outdated` vil vise deg hvilke pakker som trenger Ã¥ oppdateres manuelt, men ogsÃ¥ noen som ikke _kan_ oppdateres. Noen ganger har vi avhengigheter som trenger en eldre majorversjon av en pakke.

                      Du kan sannsynligvis trygt ignorere `overrides` med mindre noe brekker senere.

                      Vi bruker `pnpm.overrides`-feltet i `package.json` til Ã¥ overstyre vÃ¥re dependencies sine dependencies. Generelt sett gjÃ¸r vi dette for Ã¥ fÃ¥ med oss feilrettinger og sikkerhetsoppdateringer. Noen ganger er disse avhengigheter av avhengigheter av avhengigheter, og ett eller annet sted pÃ¥ veien er en pakke ikke vedlikeholdt.

                      ğŸ§‘â€ğŸ’» Endre versjoner i `package.json` til versjonen du Ã¸nsker.

                      Som nevnt kan du sannsynligvis ignorere `overrides`. Typedefinisjoner for Node kan du la vÃ¦re til vi eventuelt endrer `.nvmrc`.

                      ğŸ§‘â€ğŸ’» KjÃ¸r `pnpm install`.

                      Du skal fÃ¥ en oppdatert `pnpm-lock.yaml`. Ta en titt pÃ¥ diffen og se at det virker fornuftig.

                      ğŸ§‘â€ğŸ’» KjÃ¸r `pnpm audit --fix` pÃ¥ rotnivÃ¥ i prosjektet.

                      Hvis det er audit-problemer etter oppdateringen din kan det hende du mÃ¥ legge til noen overstyringer i `resolutions` i `package.json`. Se [pnpm-dokumentasjonen](https://classic.pnpmpkg.com/lang/en/docs/selective-version-resolutions/) om du ikke har gjort dette fÃ¸r, eller spÃ¸r en kollega om hjelp.

                      ğŸ§‘â€ğŸ’» Lag eventuelle nye patcher.

                      Vi har [noen fÃ¥ pakker hvor vi gjÃ¸r egne patcher](https://github.com/fremtind/jokul/tree/main/patches) i JÃ¸kul. Disse krever at vi lager en tilsvarende patch pÃ¥ den nye versjonen. Se README for instrukser.

                      ğŸ§‘â€ğŸ’» KjÃ¸r `pnpm build:docs`, `pnpm ci:test` og `pnpm serve`.

                      Sjekk at ting fortsatt bygger, tester gÃ¥r grÃ¸nt, og at siden funker OK.

                      TypeScript kan finne pÃ¥ Ã¥ klage over at noe er definert to ganger. Det er typisk `@types/eslint`, `@types/node`, `@types/react` eller `@types/react-dom` som er kilden. Du mÃ¥ i disse tilfellene inn og endre manuelt pÃ¥ lockfila sÃ¥ vi ikke ender opp med duplikate versjoner. SpÃ¸r en kollega om du stÃ¥r fast.

                      ğŸ§‘â€ğŸ’» KjÃ¸r `pnpm commit` og lag en `chore`-commit.

                      Snart klar for en pull request!

                      ğŸ§‘â€ğŸ’» Push endringene dine og Ã¥pne en pull request.
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

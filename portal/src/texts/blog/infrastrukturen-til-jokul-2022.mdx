---
title: Infrastrukturen til J칮kul
author: William Killerud
publishDate: "2022.03.09"
---

Fredag 4. mars holdt jeg en kort presentasjon om infrastrukturen til J칮kul for ansatte i Fremtind. Det var en lyninnf칮ring i monorepo og verkt칮yene vi bruker for 친 g친 fra kode p친 `localhost` til endringen er i produksjon.

Dette er en oppsummering for de som ikke fikk med seg presentasjonen _live_. Fremtind-ansatte kan ogs친 finne et opptak av presentasjonen under Fagtimen.

Her er [FigJamen jeg brukte](https://www.figma.com/file/tUnhcpsbsdJz1LNT0153I7/Fagtime-om-infrastrukturen-til-J%C3%B8kul?node-id=0%3A1) underveis i presentasjonen om du vil bla litt i den selv:

<iframe
    style={{ border: "1px solid rgba(0, 0, 0, 0.1)" }}
    width="800"
    height="450"
    src="https://www.figma.com/embed?embed_host=share&url=https%3A%2F%2Fwww.figma.com%2Ffile%2FtUnhcpsbsdJz1LNT0153I7%2FFagtime-om-infrastrukturen-til-J%25C3%25B8kul%3Fnode-id%3D0%253A1"
    allowfullscreen
/>

## Lyninnf칮ring i monorepo

Koden til J칮kul er organisert som et _monorepo_ i repositoriet [fremtind/jokul](https://github.com/fremtind/jokul/) p친 GitHub.

Kort fortalt g친r id칠en om et monorepo ut p친 at man samler flere selvstendige men relaterte prosjekter i det samme Git-repositoriet. Det gj칮r det enklere 친 gj칮re endringer p친 tvers av disse prosjektene, men gir noen unike utfordringer.

[Monorepo.tools](https://monorepo.tools) har en fin oversikt om du vil l칝re litt mer.

For J칮kul sin del betyr det at vi har en samling med selvstendige pakker i mappen [packages](https://github.com/fremtind/jokul/tree/main/packages), i tillegg til [portalen](https://github.com/fremtind/jokul/tree/main/portal). Pakkene (og portalen) er organisert med [Yarn workspaces](https://classic.yarnpkg.com/en/docs/workspaces) slik at pakker som avhenger av hverandre i monorepoet alltid bruker den lokale versjonen, ikke versjonen som er publisert p친 NPM. Det gj칮r det mye enklere 친 teste endringer.

I tillegg finner du en [package.json](https://github.com/fremtind/jokul/blob/main/package.json) p친 rotniv친 i repositoriet. Her samler vi avhengigheter, konfigurasjon og scripts som gjelder for _alle_ pakkene.

## La oss gj칮re en endring

La oss f칮lge en tenkt endring hvor vi legger til en ID-prop i `LoaderProps`-interfacet:

```tsx
export interface LoaderProps {
    id?: string; // Denne!
    className?: string;
}
```

### Kj칮r bygg og tester

N친r endringen er gjort m친 vi sjekke at vi ikke har innf칮rt noen feil. Det gj칮r vi ved 친 kj칮re `yarn build` og `yarn ci:test` fra [rotniv친](https://github.com/fremtind/jokul/blob/main/package.json). Hva skjer da?

Hver pakke har sitt eget `build`-script som beskriver hvordan den pakken bygges. P친 rotniv친 ber vi [Turborepo][] ta seg av kj칮ringen av disse scriptene.

Turborepo bygger pakker i riktig rekkef칮lge, og cacher resultatet mellom bygg. Hvis en pakke ikke har noen endringer s친 kj칮res heller ikke bygget. Det sparer oss for potensielt mye tid, siden et bygg av alle pakker tar et par minutter.

Byggscriptene ute i pakkene ser for det meste ganske like ut.

-   Reactpakkene bruker [Rollup][] og [Babel][] for 친 kompilere TypeScript til JavaScript.
-   Stilpakkene bruker [Gulp][] for 친 kompilere [Sass][] til CSS

Enhetstesting gj칮res med [Jest][], og linting med [ESLint][] og [Stylelint][]. Til slutt gj칮r testscriptet en typesjekk med [TypeScript](https://www.typescriptlang.org/tsconfig/#noEmit).

### Lag en commit

I J칮kul bruker vi [Commitizen][] for 친 f친 strukturerte commitmeldinger i et spesielt format, [Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0/). Formatet bruker vi senere for 친 automatisk beregne riktig versjonsnummer n친r endringen skal publiseres, og for 친 legge til commitmeldingene i pakkens changelog.

Vi har en egen kommando, `yarn commit`, som tar deg gjennom en veiviser, s친nn at du slipper 친 tenke p친 formatering.

F칮r commiten lages kj칮res det et par kommandoer i en precommit-hook, satt opp med [Husky][] og [lint-staged][]. Hooken kj칮rer [Commitlint][] og [Prettier][], i tillegg til [ESLint][] og [Stylelint][] med "auto-fix" skrudd p친. Dette er en ekstra liten sikkerhetssjekk, og s칮rger for at all koden i J칮kul f칮lger det samme formatet uten at utviklere trenger 친 tenke noe p친 det.

## Hva skjer under en pull request?

Pull requests sjekkes av en [workflow p친 GitHub Actions](https://github.com/fremtind/jokul/blob/main/.github/workflows/pull_request.yml). Den gj칮r en hel del ting i bakgrunnen for 친 sikre at det ikke har skjedd noe uventet.

Workflowen gj칮r en rask sjekk for 친 se om det er endret noen filer som gj칮r at vi trenger en grundig sjekk. Hvis det for eksempel bare er endret litt p친 en tekst i en Readme-fil s친 trenger vi ikke kj칮re alle mulige slags tester.

I eksempelet v친rt gj칮r vi endring i TypeScript, s친 da blir det _full pakke_ 游꼣

### Actions bygger

Actions bygger pakkene med [Turborepo][] p친 samme m친te som p친 `localhost`. S친 bygger den portalen.

Portalen er laget med [Gatsby][] for 친 kunne bruke React-komponentene fra J칮kul for 친 bygge statiske nettsider. Innholdet kommer for det meste fra `.mdx`-filer rundtomkring, som er Markdown med React-st칮tte.

### Actions tester

Actions kj칮rer de samme testene som vi gjorde lokalt, men i tillegg kj칮res visuelle regresjonstester med [Cypress][]. Cypress-testene fordeles i en matrise med fem _runners_. Hver runner kj칮rer en versjon av portalen som nettop ble bygget.

For hver test tar Cypress et skjermbilde og sammenligner med et skjermbilde som ligger i Git. P친 den m친ten fanger vi opp uforventede endringer.

### Actions forh친ndsviser

Til slutt bygger Actions ogs친 en versjon av portalen med en annen URL, og denne publiseres p친 [GitHub Pages](https://pages.github.com) som et slags "staging-milj칮" s친 vi kan forh친ndsvise endringer.

Hvis alle automatiske tester g친r OK og du f친r en godkjent review av en kollega er det klart for 친 merge.

## Automatisert publisering

N친r en pull request merges er det [release-workflowen](https://github.com/fremtind/jokul/blob/main/.github/workflows/release.yml) som tar over. Det er her [Lerna][] kommer inn og sjekker Git-historikken sammenlignet med forrige publisering. Hele denne workflowen g친r uten at et menneske er involvert 游뱄

### Versjonering

Lerna leser [commitmeldinger](https://www.conventionalcommits.org/en/v1.0.0/) for 친 se om det skal publiseres en ny [SemVer](https://semver.org) _patch_, _minor_, eller _major_. For eksempel:

-   `BREAKING CHANGE:` blir til en major
-   `feat:` blir til en minor
-   `fix:` blir til en patch

Det kan v칝re mange commits som samles inn i samme release, og Lerna er smart nok til 친 velge rett versjon fra samlingen. For eksempel vil en `fix` pluss en `BREAKING CHANGE` totalt sett bli 칠n major-versjon, ikke f칮rst en patch og s친 en major.

N친r Lerna har beregnet ferdig oppdaterer den alle `package.json` i repoet med de nye versjonsnummerene. Lerna samler ogs친 alle commitmeldinger og putter dem i pakkenes changelogs.

### Publisering

Ved publisering bygger Actions pakkene p친 samme m친te som f칮r, med Turborepo. Deretter publiserer Lerna de nye pakkene til [NPM](https://www.npmjs.com/search?q=keywords%3Afremtind) og [GitHub Packages](https://github.com/orgs/fremtind/packages?repo_name=jokul).

Til slutt bygger Actions en ny versjon av portalen som publiseres til GitHub Pages.

N친 er alt klart til 친 brukes! 游꿀

## Sp칮rsm친l som ble stilt

**Hvorfor er det delt i to pakker, en for CSS og en for React?**

Det gir en st칮rre fleksibilitet. Ikke alle kan bruke React, og om f. eks. React-koden gj칮r `import "./styles.scss"` for 친 f친 stiler ville det lagt ganske kraftige f칮ringer for hvilke byggverkt칮y som brukes ute i teamene.

## Veien videre

Vi unders칮ker for tiden alternativer til Lerna, siden det dessverre ikke vedlikeholdes og holder oss p친 Yarn Classic. Du kan f칮lge [diskusjonen p친 GitHub](https://github.com/fremtind/jokul/discussions/2626) om du vil se mer om alternativene og veien videre.

[rollup]: https://rollupjs.org/guide/en/
[gulp]: https://gulpjs.com
[jest]: https://jestjs.io
[lerna]: https://github.com/lerna/lerna
[turborepo]: https://turborepo.org
[babel]: https://babeljs.io
[sass]: https://sass-lang.com
[eslint]: https://eslint.org
[stylelint]: https://stylelint.io
[commitizen]: https://github.com/commitizen/cz-cli
[commitlint]: https://commitlint.js.org/
[lint-staged]: https://github.com/okonet/lint-staged
[husky]: https://github.com/typicode/husky
[prettier]: https://prettier.io
[gatsby]: https://www.gatsbyjs.com
[cypress]: https://www.cypress.io
